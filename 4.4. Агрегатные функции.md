# 4.4. Агрегатные функции

## Агрегатные функции

В предыдущих уроках мы знакомились с такими встроенными функциями MySQL, как _ROUND, CONCAT, GREATEST, LEAST, UPPER, LOWER_ и др. Они относятся к _**скалярным функциям,**_ которые выполняют вычисления над одним значением или списком значений.

В данном уроке мы ознакомимся с _**агрегатными функциями**_, которые выполняют вычисления над группой значений из нескольких строк.

Проще говоря, в рамках работы с таблицей, скалярные функции выполняют вычисления в рамках **одной** строки, а агрегатные функции выполняют вычисления в рамках нескольких строк.

<image src="/img/4.4. pic1.png" alt="">
<image src="/img/4.4. pic2.png" alt="">
<br>
<br>

В MySQL представлены следующие агрегатные функции:

|Название функции|Описание|
|---|---|
|AVG(выражение)|Вычисляет среднее значение|
|SUM(выражение)|Вычисляет сумму значений|
|MIN(выражение)|Вычисляет наименьшее значение|
|MAX(выражение)|Вычисляет наибольшее значение|
|COUNT(выражение)|Вычисляет количество значений в указанном выражении|
|COUNT(*)|Возвращает количество строк источника записей|

Обычно в качестве _**выражения**_ выступает название столбца, над значениями которого надо проводить вычисления. Для AVG и SUM выражение должно быть числовым, в остальных функциях может быть датой, строкой или числом.

Все агрегатные функции за исключением COUNT(*) игнорируют значения NULL. 

Разница между функцией COUNT(*) и COUNT(выражение) состоит в том, что вторая (как и остальные агрегатные функции) при подсчете не учитывает NULL-значения.

<image src="/img/4.4. pic3.png" alt="">
<br>
<br>

На примере функции AVG разберем применение функции в запросе.

Посчитаем среднюю стоимость посещения в таблице _**talons**_:

<image src="/img/4.4. pic4.png" alt="">
<br>

Запрос будет иметь следующий вид:

```sql
SELECT AVG(visit_amount) AS avg_amount 
FROM talons;	
```
<br>

Для поиска среднего значения в качестве выражения в функцию AVG передается столбец _**visit_amount**_. Для получаемого значения устанавливается алиас(псевдоним) _**avg_amount**_, хотя в принципе устанавливать псевдоним необязательно.

Результат запроса:

<image src="/img/4.4. pic5.png" alt="">
<br>

Также можно ограничить исходные строки, используя оператор WHERE. Например, чтобы найти среднюю стоимость приема для доктора с номером 3 и 2 нужно выполнить следующий запрос:

```sql
SELECT AVG(visit_amount) AS avg_amount
FROM talons
WHERE doctor_num IN (2,3);
```
<br>

Результат:

<image src="/img/4.4. pic6.png" alt="">
<br>
<br>
<br>

### **_Найдите максимальный номер кабинета. Присвойте вычисляемому полю название max_cabinet._**

Исходная таблица _**doctors**_:

<image src="/img/4.4. pic7.png" alt="">
<br>

```sql
SELECT MAX(cabinet_num) AS max_cabinet
FROM doctors
```
<br>
<br>
<br>

### **_Найти количество всех врачей. Присвойте вычисляемому полю название count_docs._**

Исходная таблица _**doctors**_:

<image src="/img/4.4. pic8.png" alt="">
<br>

```sql
SELECT COUNT(doctor_name) AS count_docs
FROM doctors
```
<br>
<br>
<br>

### _**Какой результат вернет следующий запрос:**_

```sql
SELECT COUNT(spec) AS count_spec 
FROM doctors;
```

Исходная таблица:

<image src="/img/4.4. pic9.png" alt="">
<br>

 -  [ ] 0
 -  [x] 3
 -  [ ] 1
 -  [ ] 4
<br>
<br>
<br>

### _**Посчитайте общую выручку за визиты к врачам за 2023 год (используйте функцию YEAR). Вычисляемое поле назовите sum_amount_2023.**_

Исходная таблица talons:

<image src="/img/4.4. pic10.png" alt="">
<br>

```sql
SELECT SUM(visit_amount) AS sum_amount_2023
FROM talons
WHERE YEAR(visit_time) = 2023
```
